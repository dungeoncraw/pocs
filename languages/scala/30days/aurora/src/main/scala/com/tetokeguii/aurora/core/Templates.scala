package com.tetokeguii.aurora.core

import scalatags.Text.all.*
import scalatags.Text.tags2.{nav, article, main as mainTag}

object Templates:
  def layout(titleStr: String, siteTitle: String)(contentBody: Modifier*): String =
    "<!DOCTYPE html>" + html(
      head(
        scalatags.Text.tags2.title(s"$titleStr | $siteTitle"),
        meta(charset := "utf-8"),
        meta(name := "viewport", content := "width=device-width, initial-scale=1"),
        script(raw("""
          const eventSource = new EventSource('/sse');
          eventSource.onmessage = function(event) {
            if (event.data === 'reload') {
              window.location.reload();
            }
          };
        """))
      ),
      body(
        tag("header")(
          h1(siteTitle),
          nav(
            a(href := "/", "Home"),
            raw(" | "),
            a(href := "/search.html", "Search")
          )
        ),
        mainTag(contentBody),
        tag("footer")(
          p(s"Generated by Aurora Press")
        )
      )
    ).render

  def post(fm: FrontMatter, htmlContent: String, siteTitle: String): String =
    layout(fm.title, siteTitle)(
      article(
        tag("header")(
          h2(fm.title),
          p(s"Published on ${fm.date}"),
          if fm.tags.nonEmpty then
            p("Tags: " + fm.tags.mkString(", "))
          else
            div()
        ),
        raw(htmlContent)
      )
    )

  def index(posts: List[(FrontMatter, String)], siteTitle: String, siteDesc: String): String =
    layout("Home", siteTitle)(
      h2(siteDesc),
      ul(
        for (fm, slug) <- posts yield
          li(
            a(href := s"/${ProjectPaths.Posts.path}/$slug.html", fm.title),
            span(s" - ${fm.date}")
          )
      ),
      h3("Tags"),
      div({
        val allTags = posts.flatMap(_._1.tags).distinct.sorted
        for tagStr <- allTags yield
          a(href := s"/tags/$tagStr.html", style := "margin-right: 10px")(tagStr)
      })
    )

  def tagPage(tag: String, posts: List[(FrontMatter, String)], siteTitle: String): String =
    layout(s"Tag: $tag", siteTitle)(
      h2(s"Posts tagged with '$tag'"),
      ul(
        for (fm, slug) <- posts yield
          li(
            a(href := s"/${ProjectPaths.Posts.path}/$slug.html", fm.title),
            span(s" - ${fm.date}")
          )
      )
    )

  def search(siteTitle: String): String =
    layout("Search", siteTitle)(
      h2("Search"),
      input(id := "search-input", `type` := "text", placeholder := "Search..."),
      div(id := "search-results"),
      script(raw("""
        async function search() {
          const query = document.getElementById('search-input').value.toLowerCase();
          const response = await fetch('/search-index.json');
          const index = await response.json();
          const results = index.filter(item => 
            item.title.toLowerCase().includes(query) || 
            item.content.toLowerCase().includes(query)
          );
          const resultsDiv = document.getElementById('search-results');
          resultsDiv.innerHTML = results.map(item => `
            <div>
              <h3><a href="/posts/${item.slug}.html">${item.title}</a></h3>
              <p>${item.content}...</p>
            </div>
          `).join('');
        }
        document.getElementById('search-input').addEventListener('input', search);
      """))
    )
